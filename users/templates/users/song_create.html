{% extends 'base.html' %}

{% load widget_tweaks %}

{% block title %}Create Song{% endblock %}

{% block content %}
    <ol class="breadcrumb">
        <li><a href="{% url 'users:songs' user.username %}">My Songs</a></li>
        <li class="active">Create Song</li>
    </ol>

    {% if form.errors %}
        <div class="alert alert-danger">Please correct the errors below:</div>
    {% endif %}

    <form action="" method="post">
        {% csrf_token %}
        <legend>Create Song</legend>
        <div class="form-group">
            <label for="id_title">Title</label>
            {% render_field form.title class+="form-control" required="required" %}
            {% if form.title.errors %}
                <p class="errors">{{ form.title.errors.as_text }}</p>
            {% endif %}
        </div>
        <div class="form-group">
            <input type="hidden" id="id_media_url_value" name="media_url"/>
            <input type="file" id="id_media_url" required/>
            <p id="status">Please select a file</p>
        </div>
        <div class="form-group">
            <button id="submit-song" class="btn btn-primary" type="submit">Save</button>
        </div>
    </form>

    <script>
        $(document).ready(function () {
            $("#id_media_url").on('change', function () {
                try {
                    $("#submit-song").prop('disabled', true);
                    var files = $(this)[0].files;
                    var file = files[0];

                    if (!file) {
                        return console.error("No file selected.");
                    }
                    getSignedRequest(file);
                } catch (error) {
                    console.error(error);
                    $("#submit-song").prop('disabled', false);
                }
            });
        });

        function getSignedRequest(file) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/songs/upload?file_name=" + file.name + "&file_type=" + file.type);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        uploadFile(file, response.data, response.url);
                    }
                    else {
                        console.error("Could not get signed URL.");
                    }
                }
            };
            xhr.send();
        }

        function uploadFile(file, s3Data, url) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", s3Data.url);

            var postData = new FormData();
            for (key in s3Data.fields) {
                postData.append(key, s3Data.fields[key]);
            }
            postData.append('file', file);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200 || xhr.status === 204) {
                        $("#id_media_url_value").val(url);
                        $("#submit-song").prop('disabled', false);
                    }
                    else {
                        console.error("Could not upload file.");
                    }
                }
            };
            xhr.send(postData);
        }
    </script>
{% endblock %}